{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Document - RAG AI Assistant{% endblock %}

{% block content %}
<div class="bg-gray-800 rounded-xl border border-gray-700 p-8">
    <form 
        id="upload-form"
        hx-post="{% url 'documents:upload' %}"
        hx-encoding="multipart/form-data"
        hx-target="#upload-status"
        hx-swap="innerHTML"
        enctype="multipart/form-data"
    >
        {% csrf_token %}
        
        <!-- File Upload Area -->
        <div class="mb-6">
            <label class="block text-sm font-medium mb-2">Choose Files</label>
            <div 
                class="border-2 border-dashed border-gray-600 rounded-lg p-12 text-center hover:border-blue-500 transition-colors"
                id="drop-zone"
                ondrop="handleDrop(event)"
                ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)"
            >
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-500 mb-4"></i>
                <p class="text-gray-400 mb-2">Drag and drop files here, or click to browse</p>
                <input 
                    type="file" 
                    name="file"
                    id="file-input"
                    class="hidden"
                    multiple
                    accept=".pdf,.docx,.txt,.md"
                    onchange="handleFileSelect(event)"
                />
                <button 
                    type="button"
                    onclick="document.getElementById('file-input').click()"
                    class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm"
                >
                    Browse Files
                </button>
                <p class="text-xs text-gray-500 mt-2">
                    Supported: PDF, DOCX, TXT, MD (Max 10MB per file)
                </p>
            </div>
        </div>

        <!-- File Preview -->
        <div id="file-preview" class="mb-6 hidden">
            <label class="block text-sm font-medium mb-2">Selected Files</label>
            <div id="file-list" class="space-y-2"></div>
        </div>

        <!-- Document Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="title" class="block text-sm font-medium mb-2">Document Title</label>
                <input 
                    type="text"
                    name="title"
                    id="title"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Auto-generated from filename"
                />
            </div>
            <div>
                <label for="tags" class="block text-sm font-medium mb-2">Tags</label>
                <input 
                    type="text"
                    name="tags"
                    id="tags"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="research, report, manual (comma-separated)"
                />
            </div>
        </div>

        <div class="mb-6">
            <label for="description" class="block text-sm font-medium mb-2">Description (Optional)</label>
            <textarea 
                name="description"
                id="description"
                rows="3"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Brief description of the document content..."
            ></textarea>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
            <button 
                type="submit"
                id="upload-btn"
                class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <i class="fas fa-upload mr-2"></i>
                Upload & Process
            </button>
        </div>
    </form>

    <!-- Upload Status -->
    <div id="upload-status" class="mt-6"></div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const fileList = document.getElementById('file-list');
    let selectedFiles = [];

    function handleDragOver(e) {
        e.preventDefault();
        dropZone.classList.add('border-blue-500');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500');
    }

    function handleDrop(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500');
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    }

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        handleFiles(files);
    }

    function handleFiles(files) {
        selectedFiles = files;
        if (selectedFiles.length > 0) {
            filePreview.classList.remove('hidden');
            fileList.innerHTML = '';
            selectedFiles.forEach((file, idx) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between bg-gray-700 rounded-lg px-4 py-2';
                fileItem.innerHTML = `
                    <span class="truncate">${file.name}</span>
                    <span class="text-xs text-gray-400 ml-2">${(file.size/1024/1024).toFixed(2)} MB</span>
                    <button type="button" class="ml-4 text-red-400 hover:text-red-300 text-xs" onclick="removeFile(${idx})">Remove</button>
                `;
                fileList.appendChild(fileItem);
            });
        } else {
            filePreview.classList.add('hidden');
            fileList.innerHTML = '';
        }
    }

    function removeFile(idx) {
        selectedFiles.splice(idx, 1);
        handleFiles(selectedFiles);
        fileInput.value = '';
    }
</script>
{% endblock %}
