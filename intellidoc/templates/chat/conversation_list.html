{% extends 'base.html' %}
{% load static %}

{% block title %}Chat - RAG AI Assistant{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-900">
    <!-- Sidebar -->
    <div class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Chat Sessions</h2>
                <button 
                    hx-post="{% url 'chat:create' %}"
                    hx-target="#chat-list"
                    hx-swap="afterbegin"
                    class="bg-blue-600 hover:bg-blue-700 p-2 rounded-lg"
                >
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <!-- Document Filter -->
            <select 
                id="document-filter" 
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"
                onchange="filterByDocument(this.value)"
            >
                <option value="">All Documents</option>
                {% for doc in user_documents %}
                <option value="{{ doc.id }}">{{ doc.title }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Chat List -->
        <div class="flex-1 overflow-y-auto p-4">
            <div id="chat-list">
                {% for chat in recent_chats %}
                <div 
                    class="chat-item mb-3 p-3 bg-gray-700 rounded-lg hover:bg-gray-600 cursor-pointer {% if chat.id == current_chat.id %}bg-blue-600{% endif %}"
                    data-document-id="{{ chat.document.id|default:'' }}"
                    onclick="loadChat({{ chat.id }})"
                >
                    <h3 class="font-medium truncate">{{ chat.title|default:"New Chat" }}</h3>
                    <p class="text-xs text-gray-400 mt-1">{{ chat.updated_at|timesince }} ago</p>
                    {% if chat.document %}
                    <p class="text-xs text-blue-400 mt-1">ðŸ“„ {{ chat.document.title }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <div class="bg-gray-800 border-b border-gray-700 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-semibold">{{ current_chat.title|default:"New Chat" }}</h1>
                    {% if current_chat.document %}
                    <p class="text-sm text-gray-400">Chatting with: {{ current_chat.document.title }}</p>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-2">
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-xs text-gray-400">Connected</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="flex-1 overflow-y-auto p-4" id="messages-container">
            {% if current_chat %}
            <div id="messages" hx-ext="ws" ws-connect="/ws/chat/{{ current_chat.id }}/">
                {% for message in chat_messages %}
                <div class="message mb-6 {% if message.role == 'user' %}user-message{% else %}assistant-message{% endif %}">
                    {% if message.role == 'user' %}
                    <div class="flex justify-end">
                        <div class="max-w-xs lg:max-w-md bg-blue-600 rounded-lg px-4 py-2">
                            <p class="text-white">{{ message.content }}</p>
                            <span class="text-xs text-blue-200">{{ message.created_at|date:"H:i" }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="flex justify-start">
                        <div class="max-w-xs lg:max-w-2xl bg-gray-700 rounded-lg px-4 py-2">
                            <div class="text-gray-300">{{ message.content|linebreaks }}</div>
                            {% if message.sources %}
                            <div class="mt-3 pt-3 border-t border-gray-600">
                                <p class="text-xs text-gray-500 mb-2">Sources:</p>
                                {% for source in message.sources %}
                                <div class="text-xs bg-gray-800 rounded px-2 py-1 mb-1">
                                    ðŸ“„ {{ source.document_title }} (Page {{ source.page_number|default:"N/A" }})
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <span class="text-xs text-gray-500">{{ message.created_at|date:"H:i" }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                
                <!-- Typing Indicator -->
                <div id="typing-indicator" class="hidden mb-6">
                    <div class="flex justify-start">
                        <div class="bg-gray-700 rounded-lg px-4 py-2">
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div id="messages" class="p-6 text-center text-gray-400">
                No conversation yet â€” start a new chat.
            </div>
            {% endif %}
        </div>

        <!-- Message Input -->
        <div class="border-t border-gray-700 p-4">
            {% if current_chat %}
            <form 
                id="message-form"
                hx-post="{% url 'chat:chat_message' current_chat.id %}"
                hx-target="#messages"
                hx-swap="beforeend"
                hx-on::after-request="clearInput()"
                class="flex space-x-4"
            >
                {% csrf_token %}
                <div class="flex-1 relative">
                    <input 
                        type="text" 
                        name="content"
                        id="message-input"
                        placeholder="Ask me anything about your documents..."
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        autocomplete="off"
                    />
                    <div class="absolute right-3 top-3 text-gray-500">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                </div>
                <button 
                    type="submit"
                    class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors"
                >
                    Send
                </button>
            </form>
            {% else %}
            <div class="text-center">
                <a href="{% url 'chat:create' %}" class="bg-blue-600 px-4 py-2 rounded-lg text-white">
                    Start a new chat
                </a>
            </div>
            {% endif %}
            
            <!-- Usage Info -->
            <div class="mt-2 text-xs text-gray-500 text-center">
                {{ user.daily_query_count }}/{{ user.get_daily_limit }} queries used today
                {% if user.subscription_plan == 'free' %}
                â€¢ <a href="{% url 'accounts:upgrade' %}" class="text-blue-400 hover:text-blue-300">Upgrade for more</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function loadChat(chatId) {
    window.location.href = `/chat/${chatId}/`;
}

function clearInput() {
    document.getElementById('message-input').value = '';
    scrollToBottom();
}

function scrollToBottom() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

function filterByDocument(documentId) {
    const chatItems = document.querySelectorAll('.chat-item');
    chatItems.forEach(item => {
        if (!documentId || item.dataset.documentId === documentId) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// WebSocket handlers
document.body.addEventListener('htmx:wsAfterMessage', function(e) {
    const data = JSON.parse(e.detail.message);
    if (data.type === 'typing_start') {
        document.getElementById('typing-indicator').classList.remove('hidden');
        scrollToBottom();
    } else if (data.type === 'typing_stop') {
        document.getElementById('typing-indicator').classList.add('hidden');
    } else if (data.type === 'message') {
        document.getElementById('typing-indicator').classList.add('hidden');
        scrollToBottom();
    }
});

window.onload = function() {
    scrollToBottom();
};
</script>
{% endblock %}
